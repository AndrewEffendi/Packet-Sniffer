<html>
<head>
    <title>Packet Sniffer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }
        h1 {
            color: #333;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background-color: #fff;
        }
        th, td {
            padding: 8px 12px;
            border: 1px solid #ccc;
            text-align: left;
            cursor: pointer; /* Change cursor to pointer */
        }
        th {
            background-color: #007bff;
            color: #fff;
        }
        strong {
            color: #007bff;
        }
        
        /* Modal styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgb(0,0,0); /* Fallback color */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto; /* 15% from the top and centered */
            padding: 20px;
            border: 1px solid #888;
            width: 80%; /* Could be more or less, depending on screen size */
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .container {
            text-align: left;
        }
        .input-group {
            margin: 10px 0;
        }
        input[type="text"] {
            padding: 8px;
            width: 250px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            padding: 10px 20px;
            margin: 10px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
        }
        .start-btn {
            background-color: #28a745;
            color: white;
        }
        .stop-btn {
            background-color: #dc3545;
            color: white;
        }
        button:hover {
            opacity: 0.9;
        }
    </style>
    <script>
        let modal; // Modal element
        let packetData = []; // Store packet data
        let sortDirection = {}; // Track sort direction for each column

        // Fetch packet data and render table
        function fetchPackets() {
            fetch('/packets')
                .then(response => response.json())
                .then(data => {
                    packetData = data.packets; // Store packet data globally
                    packetDetail = data.details // Store packet detail globally
                    renderTable(packetData, packetDetail); // Render table with fetched data
                });
        }

        // Render table with sorted packet data
        function renderTable(data, detail) {
            const table = document.getElementById('packetsTable');
            table.innerHTML = ''; // Clear previous entries

            // Create table headers with sorting enabled
            const headerRow = table.insertRow();
            headerRow.innerHTML = `
                <th onclick="sortTable('index')">No.</th>
                <th onclick="sortTable('elapsed_time')">Time</th>
                <th onclick="sortTable('source')">Source</th>
                <th onclick="sortTable('destination')">Destination</th>
                <th onclick="sortTable('protocol_name')">Protocol</th>
            `;

            // Add packet data to the table
            data.forEach((packet, index) => {
                const row = table.insertRow();
                row.innerHTML = `
                    <td>${packet.index + 1}</td>
                    <td>${packet.elapsed_time}</td>
                    <td>${packet.source}</td>
                    <td>${packet.destination}</td>
                    <td>${packet.protocol_name || 'N/A'}</td>
                `;
                
                // Add click event listener to the row
                row.addEventListener('click', () => {
                    if (detail && detail[index]) {
                        showPacketDetails(detail[index]); 
                    } else {
                         console.error("No details found for packet at index:", index);
                    }
                });
            });
        }

        // Sort table data by the specified column
        function sortTable(column) {
            // Toggle sort direction for the column
            sortDirection[column] = !sortDirection[column];

            // Sort the packetData array
            packetData.sort((a, b) => {
                if (a[column] < b[column]) return sortDirection[column] ? -1 : 1;
                if (a[column] > b[column]) return sortDirection[column] ? 1 : -1;
                return 0;
            });

            // Re-render table with sorted data
            renderTable(packetData);
        }

        // Function to show packet details in the modal
        function showPacketDetails(details) {
            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = details; // Set the modal content
            modal.style.display = "block"; // Show the modal
        }

        // Function to close the modal
        function closeModal() {
            modal.style.display = "none";
        }

        // Set up the modal when the page loads
        window.onload = () => {
            modal = document.getElementById('myModal');

            // When the user clicks on <span> (x), close the modal
            document.getElementsByClassName("close")[0].onclick = closeModal;

            // When the user clicks anywhere outside of the modal, close it
            window.onclick = (event) => {
                if (event.target === modal) {
                    closeModal();
                }
            };

            setInterval(fetchPackets, 1000);  // Fetch every second
        };

        async function sendStartRequest() {
            const srcIp = document.getElementById('src_ip').value;
            const destIp = document.getElementById('dest_ip').value;
            const pcapFilename = document.getElementById('pcap_filename').value;
            const selectedPacketTypes = [];
            if (document.getElementById('icmp').checked) selectedPacketTypes.push("icmp");
            if (document.getElementById('tcp').checked) selectedPacketTypes.push("tcp");
            if (document.getElementById('udp').checked) selectedPacketTypes.push("udp");
            if (document.getElementById('arp').checked) selectedPacketTypes.push("arp");

            try {
                const response = await fetch('/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ src_ip: srcIp, dest_ip: destIp, pcap_filename: pcapFilename, packet_types: selectedPacketTypes })
                });
                const data = await response.json();
                alert(data.status);
            } catch (error) {
                alert('Error communicating with server: ' + error);
            }
        }

        async function sendStopRequest() {
            try {
                const response = await fetch('/stop', { method: 'POST' });
                const data = await response.json();
                alert(data.status);
            } catch (error) {
                alert('Error communicating with server: ' + error);
            }
        }

        // Function to toggle all checkboxes when "Select All" is clicked
        function toggleAllCheckboxes(selectAllCheckbox) {
            const checkboxes = document.querySelectorAll('input[name="packet_type"]');
            checkboxes.forEach(function(checkbox) {
                checkbox.checked = selectAllCheckbox.checked; // Set all checkboxes to the state of the "Select All" checkbox
            });
        }
    </script>
</head>
<body>
    <h1>Packet Sniffer</h1>
    <div class="container">
        <div class="input-group">
            <label for="src_ip">Source IP Address:</label><br>
            <input type="text" id="src_ip" name="src_ip" placeholder="e.g., 192.168.1.1">
        </div>
        <div class="input-group">
            <label for="dest_ip">Destination IP Address:</label><br>
            <input type="text" id="dest_ip" name="dest_ip" placeholder="e.g., 192.168.1.1">
        </div>
        <div class="input-group">
            <label>Packet Type:</label><br>
            <input type="checkbox" id="select_all" name="select_all" onclick="toggleAllCheckboxes(this)"> All<br>
            <input type="checkbox" id="icmp" name="packet_type" value="icmp"> ICMP<br>
            <input type="checkbox" id="tcp" name="packet_type" value="tcp"> TCP<br>
            <input type="checkbox" id="udp" name="packet_type" value="udp"> UDP<br>
            <input type="checkbox" id="arp" name="packet_type" value="arp"> ARP<br>
        </div>
        <div class="input-group">
            <label for="pcap_filename">PCAP Filename :</label><br>
            <input type="text" id="pcap_filename" name="pcap_filename" placeholder="captured_packets">
        </div>
        <button class="start-btn" onclick="sendStartRequest()">Start Sniffing</button>
        <button class="stop-btn" onclick="sendStopRequest()">Stop Sniffing</button>
    </div>
    <h1>Captured Packets</h1>
    <table id="packetsTable"></table>

    <!-- Modal -->
    <div id="myModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Packet Details</h2>
            <div id="modalContent"></div> <!-- Where the packet details will be shown -->
        </div>
    </div>
</body>
</html>